# Архиватор файлов из интернета

## Обзор

**Архиватор jpeg и pdf файлов из интернета**
- Это REST API сервер, предназначенный для управления задачами по скачиванию файлов по предоставленным URL, и их архивированию в ZIP-архивы.
- Api проверяет типы и размеры файлов на основе конфигурации, гарантируя, что обрабатываются только файлы с разрешенными расширениями (например, PDF, JPEG) и в пределах заданного размера.
- Сервер использует in-memory репозиторий для управления задачами и предоставляет конечные точки для создания задач, добавления URL, проверки статуса задач и получения списка активных задач.

---

## Возможности

- **Управление задачами**: Создание и управление задачами для скачивания и архивирования файлов.
- **Валидация файлов**: Проверка файлов на соответствие разрешенным расширениям (например, PDF, JPEG) и максимальному размеру.
- **Логирование**: Детализированное логирование с использованием `slog` для отслеживания ошибок и событий.
- **Graceful Shutdown**: Корректное завершение работы сервера с таймаутом для завершения активных операций.
- **Конфигурация через `.env`**: Настройка порта сервера, таймаутов, максимального размера файлов и разрешенных расширений.
- **In-memory хранилище**: Хранение данных о задачах в оперативной памяти с использованием потокобезопасного репозитория.

---

## Структура проекта

```
api_files_archiver/
├── archives/                     # Папка для хранения ZIP-архивов
├── cmd/
│   └── main.go                   # Точка входа приложения
├── docs/                         # Папка для сгенерированной Swagger-документации
├── internal/
│   ├── config/
│   │   └── config.go             # Загрузка и обработка конфигурации из .env
│   ├── handlers/
│   │   └── task_handler.go       # HTTP-обработчики для REST API эндпоинтов
│   ├── repository/
│   │   └── task_repo.go          # Репозиторий для хранения данных в памяти
│   └── service/
│       └── task_service.go       # Бизнес-логика для обработки задач
├── downloads/                    # Временная папка для хранения скачанных файлов
├── .env                          # Конфигурационный файл
├── go.mod                        # Файл модуля Go с зависимостями
└── README.md                     # Документация проекта
```

---

## Требования

- **Go**: Версия 1.23.6 или выше.
- **Операционная система**: Linux, macOS или Windows.
- **Зависимости**: Отсутствуют внешние зависимости, используется стандартная библиотека Go.

---

## Установка и запуск

1. **Клонируйте репозиторий**:
   ```bash
   git clone <URL_репозитория>
   cd api_files_archiver
   ```

2. **Создайте файл `.env`** в корне проекта с необходимыми параметрами:
   ```env
   SERVER_PORT=8080
   SERVER_TIMEOUT=30s
   FILE_MAX_SIZE=10485760
   FILE_ALLOWED_EXTENSIONS=[pdf,jpeg]
   ```
    - `SERVER_PORT`: Порт, на котором запускается сервер.
    - `SERVER_TIMEOUT`: Таймаут для чтения/записи HTTP-запросов (например, `30s`).
    - `FILE_MAX_SIZE`: Максимальный размер файла в байтах (например, `10485760` = 10 МБ).
    - `FILE_ALLOWED_EXTENSIONS`: Список разрешенных расширений файлов в формате `[ext1,ext2]`.

3. **Запустите приложение**:
   ```bash
   go run cmd/main.go
   ```
   Сервер запустится на указанном порту (по умолчанию `8080`) и будет готов принимать запросы.

---

## API Эндпоинты

### 1. Создание задачи
- **Эндпоинт**: `POST /tasks`
- **Описание**: Создает новую задачу для скачивания и архивирования файлов.
- **Ограничение**: Максимум 3 активные задачи одновременно.
- **Запрос**:
  ```http
  POST /tasks HTTP/1.1
  Content-Type: application/json
  ```
  Тело запроса не требуется.
- **Успешный ответ** (HTTP 201):
  ```json
  {
    "Задача номер: ": 1
  }
  ```
- **Ошибки**:
    - `503 Service Unavailable`: Сервер занят (превышен лимит активных задач).
    - `500 Internal Server Error`: Ошибка создания задачи.

### 2. Добавление ссылок к задаче
- **Эндпоинт**: `POST /tasks/{id}/links`
- **Описание**: Добавляет URL-адреса файлов к задаче с указанным ID.
- **Ограничение**: Максимум 3 URL на задачу.
- **Запрос**:
  ```http
  POST /tasks/1/links HTTP/1.1
  Content-Type: application/json

  {
    "urls": [
      "https://example.com/file1.pdf",
      "https://example.com/file2.jpeg"
    ]
  }
  ```
- **Успешный ответ** (HTTP 202):
  ```json
  {
    "message": "Ссылки добавлены, обработка начата"
  }
  ```
- **Ошибки**:
    - `400 Bad Request`: Неверный формат URL или ID задачи.
    - `404 Not Found`: Задача не найдена.
    - `400 Bad Request`: Превышен лимит URL (3 ссылки).
    - `500 Internal Server Error`: Ошибка обработки задачи.

### 3. Получение статуса задачи
- **Эндпоинт**: `GET /tasks/{id}/status`
- **Описание**: Возвращает статус задачи и, при завершении, ссылку на ZIP-архив.
- **Запрос**:
  ```http
  GET /tasks/1/status HTTP/1.1
  ```
- **Успешный ответ** (HTTP 200):
    - Если задача в процессе:
      ```json
      {
        "status": "в процессе"
      }
      ```
    - Если задача завершена:
      ```json
      {
        "status": "завершена",
        "archive_url": "http://localhost:8080/archives/Task_01.zip"
      }
      ```
    - Если задача неуспешна:
      ```json
      {
        "status": "неуспешно"
      }
      ```
    - Если есть предупреждения при скачивании:
      ```json
      {
        "status": "завершена",
        "archive_url": "http://localhost:8080/archives/Task_01.zip",
        "warn_01": "Ошибка скачивания файла #1: недопустимый тип файла"
      }
      ```
- **Ошибки**:
    - `400 Bad Request`: Неверный формат ID задачи.
    - `404 Not Found`: Задача не найдена.
    - `500 Internal Server Error`: Ошибка получения статуса.

### 4. Получение активных задач
- **Эндпоинт**: `GET /tasks/active`
- **Описание**: Возвращает список всех активных задач (со статусами "создали" или "в процессе").
- **Запрос**:
  ```http
  GET /tasks/active HTTP/1.1
  ```
- **Успешный ответ** (HTTP 200):
  ```json
  [
    {
      "task_id": 1,
      "status": "в процессе",
      "urls": [
        "https://example.com/file1.pdf"
      ]
    },
    {
      "task_id": 2,
      "status": "создали",
      "urls": []
    }
  ]
  ```
- **Ошибки**:
    - `500 Internal Server Error`: Ошибка получения активных задач.

---

## Обработка ошибок

Приложение реализует обработку следующих ошибок:
- `ErrTaskNotFound`: Задача не найдена.
- `ErrTooManyLinks`: Превышен лимит URL (3 ссылки на задачу).
- `ErrInvalidFile`: Недопустимое расширение или тип файла.
- `ErrFileTooLarge`: Файл превышает максимальный размер.
- `ErrServerBusy`: Превышен лимит активных задач (3 задачи).

Ошибки возвращаются в JSON-формате с соответствующими HTTP-кодами статуса.

---

## Ограничения

- Максимум 3 активные задачи одновременно.
- Максимум 3 URL на задачу.
- Поддерживаются только файлы с расширениями, указанными в конфигурации.
- Максимальный размер файла задается в конфигурации (по умолчанию 10 МБ).
- Хранение задач осуществляется в памяти (in-memory), что означает, что данные не сохраняются после перезапуска сервера.
